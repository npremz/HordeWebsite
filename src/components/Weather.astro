---
import Wrapped from './Wrapped.astro';
import { getLangFromUrl, useTranslations } from '../i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const weatherTranslations = {
	loading: t('weather.loading'),
	unavailable: t('weather.unavailable'),
	days: t('weather.days').split(','),
	codes: {
		0: [t('weather.0'), '☀'],
		1: [t('weather.1'), '⛅'],
		2: [t('weather.2'), '☁'],
		3: [t('weather.3'), '☁'],
		45: [t('weather.45'), '☁'],
		48: [t('weather.48'), '☁'],
		51: [t('weather.51'), '☂'],
		53: [t('weather.53'), '☂'],
		55: [t('weather.55'), '☂'],
		61: [t('weather.61'), '☂'],
		63: [t('weather.63'), '☂'],
		65: [t('weather.65'), '☂'],
		71: [t('weather.71'), '❄'],
		73: [t('weather.73'), '❄'],
		75: [t('weather.75'), '❄'],
		77: [t('weather.77'), '❄'],
		80: [t('weather.80'), '☂'],
		81: [t('weather.81'), '☂'],
		82: [t('weather.82'), '☂'],
		95: [t('weather.95'), '⚡'],
		96: [t('weather.96'), '⚡'],
		99: [t('weather.99'), '⚡']
	}
};

interface Props
{
	class?: string;
}

const { class: className = '' } = Astro.props;
---

<div class={`flex items-center gap-1.5 w-full ${className}`}>
	<div id="time-display" class="whitespace-nowrap ">Day --:--:--</div>
	<Wrapped device="all" padding="0.25rem">
		<div id="weather-display" class="whitespace-nowrap">{t('weather.loading')}</div>
	</Wrapped>
</div>

<script define:vars={{ weatherTranslations }}>
	// Configuration
	const LAT = 50.8503;
	const LON = 4.3517;
	
	const weatherCodes = weatherTranslations.codes;

	const days = weatherTranslations.days;

	let currentWeatherText = weatherTranslations.loading;

	function formatTime(date)
	{
		const dayName = days[date.getDay()];
		const hours = date.getHours().toString().padStart(2, '0');
		const minutes = date.getMinutes().toString().padStart(2, '0');
		const seconds = date.getSeconds().toString().padStart(2, '0');

		return `${dayName} ${hours}:${minutes}:${seconds}`;
	}

	async function fetchWeather()
	{
		try
		{
			const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&current_weather=true`);
			const data = await response.json();
			
			const code = data.current_weather.weathercode;
			const weatherInfo = weatherCodes[code] || [weatherTranslations.unavailable, ''];
			
			// On prépare juste la string "Ensoleillé ☀️"
			currentWeatherText = `${weatherInfo[0]} <span class="font-neuebit text-lg">${weatherInfo[1]}</span>`;
		}
		catch (error)
		{
			console.error("Erreur météo:", error);
			currentWeatherText = weatherTranslations.unavailable;
		}
		
		// Mise à jour immédiate du texte météo après le fetch
		const weatherEl = document.getElementById('weather-display');
		if (weatherEl)
		{
			weatherEl.innerHTML = currentWeatherText;
		}
	}

	function updateTime()
	{
		const timeEl = document.getElementById('time-display');
		if (timeEl)
		{
			const now = new Date();
			timeEl.innerText = formatTime(now);
		}
	}

	function init()
	{
		fetchWeather();
		updateTime();
		
		// Horloge : toutes les secondes
		setInterval(updateTime, 1000);
		
		// Météo : toutes les 15 minutes
		setInterval(fetchWeather, 1000 * 60 * 15);
	}

	function scheduleInit()
	{
		if ('requestIdleCallback' in window)
		{
			requestIdleCallback(() => init());
		}
		else
		{
			setTimeout(init, 0);
		}
	}

	if (document.readyState === 'complete')
	{
		scheduleInit();
	}
	else
	{
		window.addEventListener('load', scheduleInit, { once: true });
	}
</script>
