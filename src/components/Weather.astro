---
import Wrapped from './Wrapped.astro';
import { getLangFromUrl, useTranslations } from '../i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const weatherTranslations = {
	loading: t('weather.loading'),
	unavailable: t('weather.unavailable'),
	days: t('weather.days').split(','),
	codes: {
		0: [t('weather.0'), 'â˜€ï¸'],
		1: [t('weather.1'), 'â›…'],
		2: [t('weather.2'), 'â˜ï¸'],
		3: [t('weather.3'), 'â˜ï¸'],
		45: [t('weather.45'), 'ğŸŒ«ï¸'],
		48: [t('weather.48'), 'ğŸŒ«ï¸'],
		51: [t('weather.51'), 'ğŸŒ§ï¸'],
		53: [t('weather.53'), 'ğŸŒ§ï¸'],
		55: [t('weather.55'), 'ğŸŒ§ï¸'],
		61: [t('weather.61'), 'ğŸŒ§ï¸'],
		63: [t('weather.63'), 'ğŸŒ§ï¸'],
		65: [t('weather.65'), 'ğŸŒ§ï¸'],
		71: [t('weather.71'), 'â„ï¸'],
		73: [t('weather.73'), 'â„ï¸'],
		75: [t('weather.75'), 'â„ï¸'],
		77: [t('weather.77'), 'â„ï¸'],
		80: [t('weather.80'), 'ğŸŒ¦ï¸'],
		81: [t('weather.81'), 'ğŸŒ¦ï¸'],
		82: [t('weather.82'), 'â›ˆï¸'],
		95: [t('weather.95'), 'âš¡'],
		96: [t('weather.96'), 'â›ˆï¸'],
		99: [t('weather.99'), 'â›ˆï¸']
	}
};

interface Props
{
	class?: string;
}

const { class: className = '' } = Astro.props;
---

<div class={`flex items-center gap-1.5 w-full ${className}`}>
	<div id="time-display" class="whitespace-nowrap ">Day --:--:--</div>
	<Wrapped device="all" padding="0.25rem">
		<div id="weather-display" class="whitespace-nowrap">{t('weather.loading')}</div>
	</Wrapped>
</div>

<script define:vars={{ weatherTranslations }}>
	// Configuration
	const LAT = 50.8503;
	const LON = 4.3517;
	
	const weatherCodes = weatherTranslations.codes;

	const days = weatherTranslations.days;

	let currentWeatherText = weatherTranslations.loading;

	function formatTime(date)
	{
		const dayName = days[date.getDay()];
		const hours = date.getHours().toString().padStart(2, '0');
		const minutes = date.getMinutes().toString().padStart(2, '0');
		const seconds = date.getSeconds().toString().padStart(2, '0');

		return `${dayName} ${hours}:${minutes}:${seconds}`;
	}

	async function fetchWeather()
	{
		try
		{
			const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&current_weather=true`);
			const data = await response.json();
			
			const code = data.current_weather.weathercode;
			const weatherInfo = weatherCodes[code] || [weatherTranslations.unavailable, ''];
			
			// On prÃ©pare juste la string "EnsoleillÃ© â˜€ï¸"
			currentWeatherText = `${weatherInfo[0]} ${weatherInfo[1]}`;
		}
		catch (error)
		{
			console.error("Erreur mÃ©tÃ©o:", error);
			currentWeatherText = weatherTranslations.unavailable;
		}
		
		// Mise Ã  jour immÃ©diate du texte mÃ©tÃ©o aprÃ¨s le fetch
		const weatherEl = document.getElementById('weather-display');
		if (weatherEl)
		{
			weatherEl.innerText = currentWeatherText;
		}
	}

	function updateTime()
	{
		const timeEl = document.getElementById('time-display');
		if (timeEl)
		{
			const now = new Date();
			timeEl.innerText = formatTime(now);
		}
	}

	function init()
	{
		fetchWeather();
		updateTime();
		
		// Horloge : toutes les secondes
		setInterval(updateTime, 1000);
		
		// MÃ©tÃ©o : toutes les 15 minutes
		setInterval(fetchWeather, 1000 * 60 * 15);
	}

	init();
</script>
