---
import Wrapped from './Wrapped.astro';

interface Props
{
	class?: string;
}

const { class: className = '' } = Astro.props;
---

<div class={`flex items-center gap-1.5 w-full ${className}`}>
	<div id="time-display" class="whitespace-nowrap ">Day --:--:--</div>
	<Wrapped device="all" padding="0.25rem">
		<div id="weather-display" class="whitespace-nowrap">Chargement...</div>
	</Wrapped>
</div>

<script>
	// Configuration
	const LAT = 50.8503;
	const LON = 4.3517;
	
	const weatherCodes: Record<number, [string, string]> = {
		0: ['EnsoleillÃ©', 'â˜€ï¸'],
		1: ['Partiellement nuageux', 'â›…'],
		2: ['Nuageux', 'â˜ï¸'],
		3: ['Couvert', 'â˜ï¸'],
		45: ['Brouillard', 'ğŸŒ«ï¸'],
		48: ['Brouillard givrant', 'ğŸŒ«ï¸'],
		51: ['Bruine lÃ©gÃ¨re', 'ğŸŒ§ï¸'],
		53: ['Bruine', 'ğŸŒ§ï¸'],
		55: ['Bruine intense', 'ğŸŒ§ï¸'],
		61: ['Pluie faible', 'ğŸŒ§ï¸'],
		63: ['Pluie', 'ğŸŒ§ï¸'],
		65: ['Pluie forte', 'ğŸŒ§ï¸'],
		71: ['Neige faible', 'â„ï¸'],
		73: ['Neige', 'â„ï¸'],
		75: ['Neige forte', 'â„ï¸'],
		77: ['GrÃ©sil', 'â„ï¸'],
		80: ['Averses', 'ğŸŒ¦ï¸'],
		81: ['Averses modÃ©rÃ©es', 'ğŸŒ¦ï¸'],
		82: ['Violentes averses', 'â›ˆï¸'],
		95: ['Orage', 'âš¡'],
		96: ['Orage et grÃªle', 'â›ˆï¸'],
		99: ['Orage violent', 'â›ˆï¸']
	};

	const days = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];

	let currentWeatherText = 'Chargement...';

	function formatTime(date: Date): string
	{
		const dayName = days[date.getDay()];
		const hours = date.getHours().toString().padStart(2, '0');
		const minutes = date.getMinutes().toString().padStart(2, '0');
		const seconds = date.getSeconds().toString().padStart(2, '0');

		return `${dayName} ${hours}:${minutes}:${seconds}`;
	}

	async function fetchWeather()
	{
		try
		{
			const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&current_weather=true`);
			const data = await response.json();
			
			const code = data.current_weather.weathercode;
			const weatherInfo = weatherCodes[code] || ['Indisponible', ''];
			
			// On prÃ©pare juste la string "EnsoleillÃ© â˜€ï¸"
			currentWeatherText = `${weatherInfo[0]} ${weatherInfo[1]}`;
		}
		catch (error)
		{
			console.error("Erreur mÃ©tÃ©o:", error);
			currentWeatherText = "Indisponible";
		}
		
		// Mise Ã  jour immÃ©diate du texte mÃ©tÃ©o aprÃ¨s le fetch
		const weatherEl = document.getElementById('weather-display');
		if (weatherEl)
		{
			weatherEl.innerText = currentWeatherText;
		}
	}

	function updateTime()
	{
		const timeEl = document.getElementById('time-display');
		if (timeEl)
		{
			const now = new Date();
			timeEl.innerText = formatTime(now);
		}
	}

	function init()
	{
		fetchWeather();
		updateTime();
		
		// Horloge : toutes les secondes
		setInterval(updateTime, 1000);
		
		// MÃ©tÃ©o : toutes les 15 minutes
		setInterval(fetchWeather, 1000 * 60 * 15);
	}

	init();
</script>
