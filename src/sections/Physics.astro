---
import DisplayText from '../components/DisplayText.astro';
import { getLangFromUrl, useTranslations } from '../i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
---

<section class="relative overflow-hidden">
	<div id="bowl" class="relative border border-outline rounded-full h-svh mx-(--line-margin) mt-[calc(2px+var(--line-margin))] bg-fond lg:h-auto lg:aspect-square lg:max-w-[calc(100%-2*var(--line-margin))]">
		<div class="relative flex flex-col gap-5 top-1/2 -translate-y-1/2 z-10 pointer-events-none md:items-center lg:gap-10">
			<DisplayText tag='h2' class='mx-4 select-none'>{t('physics.title')}</DisplayText>
			<p class="mx-4 text-center select-none">{t('physics.instruction')}</p>
		</div>
		<div id="logo-letters" class="absolute inset-0">
			<svg width="293" height="209" viewBox="0 0 293 209" fill="none" xmlns="http://www.w3.org/2000/svg">
				<rect y="41.7891" width="41.7912" height="167.165" fill="#101010"/>
				<rect x="34.8271" y="83.5801" width="222.886" height="41.7912" fill="#101010"/>
				<path d="M41.793 41.7912C41.793 18.7105 60.5035 0 83.5841 0H250.749V41.7912H41.793Z" fill="#101010"/>
				<rect x="250.748" y="41.7891" width="41.7912" height="167.165" fill="#101010"/>
			</svg>
			<svg width="293" height="209" viewBox="0 0 293 209" fill="none" xmlns="http://www.w3.org/2000/svg">
				<path d="M0 41.7891H41.7912V167.163C18.7105 167.163 0 148.452 0 125.371V41.7891Z" fill="#101010"/>
				<path d="M41.7959 167.162H250.752C250.752 190.243 232.041 208.953 208.961 208.953H41.7959V167.162Z" fill="#101010"/>
				<path d="M41.7959 41.7912C41.7959 18.7105 60.5064 0 83.587 0H292.543V41.7912H41.7959Z" fill="#101010"/>
				<rect x="250.755" y="119.803" width="41.7912" height="47.3633" fill="#101010"/>
				<rect x="83.5918" y="83.5801" width="208.956" height="41.7912" fill="#101010"/>
			</svg>
			<svg width="293" height="209" viewBox="0 0 293 209" fill="none" xmlns="http://www.w3.org/2000/svg">
				<path d="M41.792 41.7912C41.792 18.7105 60.5025 0 83.5831 0H292.539V41.7912H41.792Z" fill="#101010"/>
				<rect x="38.9922" y="83.5801" width="253.533" height="41.7912" fill="#101010"/>
				<rect y="41.7891" width="41.7912" height="125.373" fill="#101010"/>
				<path d="M41.792 167.162H292.539V208.953H83.5831C60.5025 208.953 41.792 190.243 41.792 167.162Z" fill="#101010"/>
			</svg>
			<svg width="293" height="209" viewBox="0 0 293 209" fill="none" xmlns="http://www.w3.org/2000/svg">
				<rect width="41.7912" height="208.956" fill="#101010"/>
				<rect x="36.2217" width="214.528" height="41.7912" fill="#101010"/>
				<path d="M250.746 41.7891C273.827 41.7891 292.537 60.4996 292.537 83.5802V208.954H250.746V41.7891Z" fill="#101010"/>
			</svg>
			<svg width="293" height="209" viewBox="0 0 293 209" fill="none" xmlns="http://www.w3.org/2000/svg">
				<path d="M292.538 0V41.791H41.791V167.165C18.7105 167.165 0 148.454 0 125.373V0H292.538Z" fill="#101010"/>
				<rect x="41.7949" y="167.166" width="250.747" height="41.7912" fill="#101010"/>
			</svg>
			<svg width="293" height="209" viewBox="0 0 293 209" fill="none" xmlns="http://www.w3.org/2000/svg">
				<path d="M41.7959 41.7912C41.7959 18.7105 60.5064 0 83.587 0H292.543V41.7912H41.7959Z" fill="#101010"/>
				<rect x="38.9893" y="83.582" width="253.533" height="41.7912" fill="#101010"/>
				<rect y="41.7891" width="41.7912" height="125.373" fill="#101010"/>
				<path d="M41.7959 167.166H292.543V208.957H83.587C60.5064 208.957 41.7959 190.247 41.7959 167.166Z" fill="#101010"/>
			</svg>
			<svg width="293" height="209" viewBox="0 0 293 209" fill="none" xmlns="http://www.w3.org/2000/svg">
				<path d="M0 0H41.5302V84.0042C18.5937 84.0042 0 65.4106 0 42.4741V0Z" fill="#101010"/>
				<path d="M251.078 0H292.608V42.4741C292.608 65.4105 274.015 84.0042 251.078 84.0042V0Z" fill="#101010"/>
				<path d="M292.567 122.104H292.597V208.939H251.066V125.791H41.5322V208.939H0.00195312V122.104H0.0292969V84H292.567V122.104Z" fill="#101010"/>
			</svg>
			<svg width="293" height="209" viewBox="0 0 293 209" fill="none" xmlns="http://www.w3.org/2000/svg">
				<rect y="41.7891" width="41.7912" height="125.373" fill="#101010"/>
				<path d="M41.7959 41.7912C41.7959 18.7105 60.5064 0 83.587 0H250.752V41.7912H41.7959Z" fill="#101010"/>
				<path d="M41.7959 167.162H250.752C250.752 190.243 232.041 208.953 208.961 208.953H41.7959V167.162Z" fill="#101010"/>
				<rect x="250.753" y="41.7891" width="41.7912" height="125.373" fill="#101010"/>
			</svg>
			<svg width="293" height="209" viewBox="0 0 293 209" fill="none" xmlns="http://www.w3.org/2000/svg">
				<path d="M41.791 83.584H250.745V125.375H41.791V208.956H0V41.791H41.791V83.584Z" fill="#101010"/>
				<rect x="250.737" y="125.377" width="41.7912" height="83.5823" fill="#101010"/>
				<path d="M250.737 0C273.818 0.000122605 292.528 18.7105 292.528 41.791H292.524V83.5801H250.733V41.791H41.7812V0H250.737Z" fill="#101010"/>
			</svg>
			<svg width="293" height="209" viewBox="0 0 293 209" fill="none" xmlns="http://www.w3.org/2000/svg">
				<rect width="41.7912" height="208.956" fill="#101010"/>
				<path d="M37.6074 167.162H250.742C250.742 190.243 232.032 208.953 208.951 208.953H37.6074V167.162Z" fill="#101010"/>
				<path d="M37.6074 0H208.951C232.032 0 250.742 18.7105 250.742 41.7912H37.6074V0Z" fill="#101010"/>
				<rect x="250.751" y="41.7891" width="41.7912" height="125.373" fill="#101010"/>
			</svg>
			<svg width="293" height="209" viewBox="0 0 293 209" fill="none" xmlns="http://www.w3.org/2000/svg">
				<path d="M41.7959 41.7912C41.7959 18.7105 60.5064 0 83.587 0H292.543V41.7912H41.7959Z" fill="#101010"/>
				<rect x="38.9932" y="83.5801" width="253.533" height="41.7912" fill="#101010"/>
				<rect y="41.7891" width="41.7912" height="125.373" fill="#101010"/>
				<path d="M41.7959 167.162H292.543V208.953H83.587C60.5064 208.953 41.7959 190.243 41.7959 167.162Z" fill="#101010"/>
			</svg>
		</div>
	</div>
</section>

<style>
	#bowl {
		pointer-events: none;
	}

	#logo-letters {
		position: absolute;
		inset: 0;
		pointer-events: none;
	}

	#logo-letters svg {
		position: absolute;
		pointer-events: auto;
		cursor: grab;
		top: 0;
		left: 0;
		touch-action: none; 
	}

	#logo-letters svg:active {
		cursor: grabbing;
	}

	@media (max-width: 768px) {
		#logo-letters svg {
			pointer-events: none;
			cursor: default;
		}
	}
</style>

<script>
	import Matter from 'matter-js';

	if (typeof window !== 'undefined')
	{
		let engine: Matter.Engine | null = null;
		let runner: Matter.Runner | null = null;
		let render: Matter.Render | null = null;
		let animationFrameId: number | null = null;
		let resizeTimeout: number | undefined;

		let disableDragModeGlobal: (() => void) | null = null;

		const getLetterScale = (): number =>
		{
			const width = window.innerWidth;
			if (width < 640) return 0.15;
			if (width < 1024) return 0.31;
			if (width < 1520) return 0.44;
			if (width < 1920) return 0.58;
			if (width < 2560) return 0.75;
			return 1;
		};

		const cleanupPhysics = () =>
		{
			if (runner) Matter.Runner.stop(runner);
			if (engine)
			{
				Matter.World.clear(engine.world, false);
				Matter.Engine.clear(engine);
				if (engine.events) engine.events = {};
			}
			if (render)
			{
				Matter.Render.stop(render);
				if (render.canvas) render.canvas.remove();
			}
			if (animationFrameId) cancelAnimationFrame(animationFrameId);

			// Nettoyage des écouteurs globaux
			if (disableDragModeGlobal)
			{
				window.removeEventListener('mouseup', disableDragModeGlobal);
				window.removeEventListener('touchend', disableDragModeGlobal);
				disableDragModeGlobal = null;
			}
			
			engine = null;
			runner = null;
			render = null;
		};

		const initPhysics = () =>
		{
			cleanupPhysics();

			const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 1024;
			const { Engine, Runner, Bodies, Composite, Mouse, MouseConstraint, Events } = Matter;

			const bowlElement = document.getElementById('bowl');
			const logoContainer = document.getElementById('logo-letters');

			if (!bowlElement || !logoContainer) return;

			const letters = Array.from(logoContainer.querySelectorAll('svg'));
			if (letters.length === 0) return;

			const scale = getLetterScale();
			const bowlRect = bowlElement.getBoundingClientRect();
			
			const width = bowlRect.width;
			const height = bowlRect.height;

			engine = Engine.create();
			const world = engine.world;

			world.gravity.y = 1;

			const bowlWalls = [];
			const wallThickness = 2000;
			const cornerRadius = Math.min(width, height) / 2;
			const straightWallHeight = height - cornerRadius * 2;
			const straightWallWidth = width - cornerRadius * 2;

			// --- Murs (inchangé) ---
			bowlWalls.push(Bodies.rectangle(-wallThickness / 2, cornerRadius + straightWallHeight / 2, wallThickness, straightWallHeight, { isStatic: true, friction: 0.3, restitution: 0.3 }));
			bowlWalls.push(Bodies.rectangle(width + wallThickness / 2, cornerRadius + straightWallHeight / 2, wallThickness, straightWallHeight, { isStatic: true, friction: 0.3, restitution: 0.3 }));
			bowlWalls.push(Bodies.rectangle(cornerRadius + straightWallWidth / 2, -wallThickness / 2, straightWallWidth, wallThickness, { isStatic: true, friction: 0.3, restitution: 0.3 }));
			bowlWalls.push(Bodies.rectangle(cornerRadius + straightWallWidth / 2, height + wallThickness / 2, straightWallWidth, wallThickness, { isStatic: true, friction: 0.3, restitution: 0.3 }));

			const segments = 20;
			const corners = [
				{ cx: cornerRadius, cy: cornerRadius, startAngle: Math.PI, endAngle: Math.PI * 1.5 },
				{ cx: width - cornerRadius, cy: cornerRadius, startAngle: Math.PI * 1.5, endAngle: Math.PI * 2 },
				{ cx: width - cornerRadius, cy: height - cornerRadius, startAngle: 0, endAngle: Math.PI * 0.5 },
				{ cx: cornerRadius, cy: height - cornerRadius, startAngle: Math.PI * 0.5, endAngle: Math.PI }
			];

			corners.forEach(corner => {
				const angleStep = (corner.endAngle - corner.startAngle) / segments;
				for (let i = 0; i < segments; i++) {
					const angle1 = corner.startAngle + i * angleStep;
					const angle2 = corner.startAngle + (i + 1) * angleStep;
					const effectiveRadius = cornerRadius + wallThickness / 2;
					const x1 = corner.cx + effectiveRadius * Math.cos(angle1);
					const y1 = corner.cy + effectiveRadius * Math.sin(angle1);
					const x2 = corner.cx + effectiveRadius * Math.cos(angle2);
					const y2 = corner.cy + effectiveRadius * Math.sin(angle2);
					const wallLength = Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
					const wallAngle = Math.atan2(y2 - y1, x2 - x1);
					bowlWalls.push(Bodies.rectangle((x1 + x2) / 2, (y1 + y2) / 2, wallLength, wallThickness, { isStatic: true, angle: wallAngle, friction: 0.3, restitution: 0.3 }));
				}
			});

			Composite.add(world, bowlWalls);

			// --- Lettres ---
			const letterBodies = letters.map((svg, index) =>
			{
				const baseWidth = 293;
				const baseHeight = 209;
				const scaledWidth = baseWidth * scale;
				const scaledHeight = baseHeight * scale;
				
				const padding = 50;
				const startX = padding + Math.random() * (bowlRect.width - padding * 2);
				const startY = padding + Math.random() * (bowlRect.height - padding * 2);

				const body = Bodies.rectangle(startX, startY, scaledWidth, scaledHeight, {
					friction: 0.5,
					restitution: 0.2,
					density: 0.001,
					angle: (Math.random() - 0.5) * 0.5
				});
				svg.setAttribute('data-body-index', index.toString());
				return body;
			});

			Composite.add(world, letterBodies);

			const enableDragMode = () =>
			{
				bowlElement.style.pointerEvents = 'all';
			};

			disableDragModeGlobal = () => {
				bowlElement.style.pointerEvents = 'none';
			};

			letters.forEach(svg =>
			{
				// On utilise 'mousedown' et 'touchstart' pour réagir immédiatement
				svg.addEventListener('mousedown', enableDragMode);
				svg.addEventListener('touchstart', enableDragMode, { passive: true });

			});

			window.addEventListener('mouseup', disableDragModeGlobal);
			window.addEventListener('touchend', disableDragModeGlobal);

			// --- Souris et Scroll Fix ---
			const mouse = Mouse.create(bowlElement);
			
			mouse.pixelRatio = 1;

			mouse.element.removeEventListener("mousewheel", mouse.mousewheel);
			mouse.element.removeEventListener("DOMMouseScroll", mouse.mousewheel);

			bowlElement.style.pointerEvents = 'none';

			const mouseConstraint = MouseConstraint.create(engine, {
				mouse: mouse,
				constraint: {
					stiffness: 0.2,
					render: { visible: false }
				}
			});

			Events.on(mouseConstraint, 'mousemove', (event) => {
				mouse.position.x = event.mouse.position.x;
				mouse.position.y = event.mouse.position.y;
			});

			Composite.add(world, mouseConstraint);

			runner = Runner.create();
			Runner.run(runner, engine);

			const updateLetters = () =>
			{
				letterBodies.forEach((body, index) =>
				{
					const svg = letters[index];
					const { x, y } = body.position;
					const angle = body.angle;

					svg.style.transformOrigin = 'center center';
					svg.style.transform = `translate(${x}px, ${y}px) translate(-50%, -50%) rotate(${angle}rad) scale(${scale})`;
				});

				animationFrameId = requestAnimationFrame(updateLetters);
			};

			updateLetters();

			return () => {
				cleanupPhysics();
			};
		};

		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', initPhysics);
		} else {
			initPhysics();
		}

		window.addEventListener('resize', () => {
			const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 1024;
			if (isMobile) return;

			clearTimeout(resizeTimeout);
			resizeTimeout = setTimeout(() => {
				initPhysics();
			}, 300);
		});
	}
</script>
