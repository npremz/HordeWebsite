---
import DisplayText from '../components/DisplayText.astro';
---

<section class="relative overflow-hidden">
	<div id="bowl" class="relative border border-outline rounded-full h-svh mx-4 mt-6 bg-fond">
		<div class="relative flex flex-col gap-5 top-1/2 -translate-y-1/2 z-10 pointer-events-none">
			<DisplayText tag='h2' class='mx-4 select-none'>Nous créons des interfaces soignées, façonnées pour donner forme à vos idées et les transfomer en expériences uniques.</DisplayText>
			<p class="mx-4 text-center select-none">( Appuyez & Faites glisser pour intéragir avec eux ↓ )</p>
		</div>
		<div id="logo-letters" class="absolute inset-0">
			<svg width="44" height="31" viewBox="0 0 44 31" fill="none" xmlns="http://www.w3.org/2000/svg">
				<rect y="6.16797" width="6.17037" height="24.6815" fill="#101010"/>
				<rect x="5.14209" y="12.3398" width="32.9087" height="6.17037" fill="#101010"/>
				<path d="M6.17041 6.17037C6.17041 2.76257 8.93298 0 12.3408 0H37.0223V6.17037H6.17041Z" fill="#101010"/>
				<rect x="37.022" y="6.16797" width="6.17037" height="24.6815" fill="#101010"/>
			</svg>
			<svg width="44" height="31" viewBox="0 0 44 31" fill="none" xmlns="http://www.w3.org/2000/svg">
				<path d="M0 6.16797H6.17037V24.6791C2.76257 24.6791 0 21.9165 0 18.5087V6.16797Z" fill="#101010"/>
				<path d="M6.1709 24.6797H37.0228C37.0228 28.0875 34.2602 30.8501 30.8524 30.8501H6.1709V24.6797Z" fill="#101010"/>
				<path d="M6.1709 6.17037C6.1709 2.76257 8.93347 0 12.3413 0H43.1931V6.17037H6.1709Z" fill="#101010"/>
				<rect x="37.0229" y="17.6875" width="6.17037" height="6.99309" fill="#101010"/>
				<rect x="12.3418" y="12.3418" width="30.8519" height="6.17037" fill="#101010"/>
			</svg>
			<svg width="44" height="31" viewBox="0 0 44 31" fill="none" xmlns="http://www.w3.org/2000/svg">
				<path d="M6.17163 6.17037C6.17163 2.76257 8.9342 0 12.342 0H43.1939V6.17037H6.17163Z" fill="#101010"/>
				<rect x="5.75659" y="12.3418" width="37.4336" height="6.17037" fill="#101010"/>
				<rect y="6.16992" width="6.17037" height="18.5111" fill="#101010"/>
				<path d="M6.17163 24.6816H43.1939V30.852H12.342C8.9342 30.852 6.17163 28.0894 6.17163 24.6816Z" fill="#101010"/>
			</svg>
			<svg width="44" height="31" viewBox="0 0 44 31" fill="none" xmlns="http://www.w3.org/2000/svg">
				<rect width="6.17037" height="30.8519" fill="#101010"/>
				<rect x="5.34814" width="31.6746" height="6.17037" fill="#101010"/>
				<path d="M37.022 6.16797C40.4298 6.16797 43.1923 8.93054 43.1923 12.3383V30.8495H37.022V6.16797Z" fill="#101010"/>
			</svg>
			<svg width="44" height="31" viewBox="0 0 44 31" fill="none" xmlns="http://www.w3.org/2000/svg">
				<path d="M43.1934 0V6.16992H6.16992V24.6816C2.76232 24.6814 0 21.9184 0 18.5107V0H43.1934Z" fill="#101010"/>
				<rect x="6.17114" y="24.6797" width="37.0222" height="6.17037" fill="#101010"/>
			</svg>
			<svg width="44" height="31" viewBox="0 0 44 31" fill="none" xmlns="http://www.w3.org/2000/svg">
				<path d="M6.1709 6.17037C6.1709 2.76257 8.93347 0 12.3413 0H43.1931V6.17037H6.1709Z" fill="#101010"/>
				<rect x="5.75732" y="12.3418" width="37.4336" height="6.17037" fill="#101010"/>
				<rect y="6.16797" width="6.17037" height="18.5111" fill="#101010"/>
				<path d="M6.1709 24.6797H43.1931V30.8501H12.3413C8.93347 30.8501 6.1709 28.0875 6.1709 24.6797Z" fill="#101010"/>
			</svg>
			<svg width="44" height="31" viewBox="0 0 44 31" fill="none" xmlns="http://www.w3.org/2000/svg">
				<path d="M0 0H6.13184V12.403C2.74532 12.403 0 9.65772 0 6.2712V0Z" fill="#101010"/>
				<path d="M37.0713 0H43.2031V6.2712C43.2031 9.65773 40.4578 12.403 37.0713 12.403V0Z" fill="#101010"/>
				<path d="M43.1963 18.0273H43.2012V30.8486H37.0693V18.5713H6.13184V30.8486H0V18.0273H0.00390625V12.4004H43.1963V18.0273Z" fill="#101010"/>
			</svg>
			<svg width="44" height="31" viewBox="0 0 44 31" fill="none" xmlns="http://www.w3.org/2000/svg">
				<path d="M6.16992 12.3398H37.0215V18.5107H6.16992V30.8516H0V6.16992H6.16992V12.3398Z" fill="#101010"/>
				<rect x="37.0208" y="18.5117" width="6.17037" height="12.3407" fill="#101010"/>
				<path d="M37.0203 0C40.4271 0 43.1896 2.76148 43.1912 6.16797V12.3389H37.0203V6.1709H6.1687V0H37.0203Z" fill="#101010"/>
			</svg>
			<svg width="44" height="31" viewBox="0 0 44 31" fill="none" xmlns="http://www.w3.org/2000/svg">
				<rect y="6.16992" width="6.17037" height="18.5111" fill="#101010"/>
				<path d="M6.17114 6.17037C6.17114 2.76257 8.93371 0 12.3415 0H37.023V6.17037H6.17114Z" fill="#101010"/>
				<path d="M6.17114 24.6836H37.023C37.023 28.0914 34.2604 30.854 30.8526 30.854H6.17114V24.6836Z" fill="#101010"/>
				<rect x="37.0232" y="6.16992" width="6.17037" height="18.5111" fill="#101010"/>
			</svg>
			<svg width="44" height="31" viewBox="0 0 44 31" fill="none" xmlns="http://www.w3.org/2000/svg">
				<rect width="6.17037" height="30.8519" fill="#101010"/>
				<path d="M5.55273 24.6836H37.0216C37.0216 28.0914 34.2591 30.854 30.8513 30.854H5.55273V24.6836Z" fill="#101010"/>
				<path d="M5.55273 0H30.8513C34.2591 0 37.0216 2.76257 37.0216 6.17037H5.55273V0Z" fill="#101010"/>
				<rect x="37.0227" y="6.16992" width="6.17037" height="18.5111" fill="#101010"/>
			</svg>
			<svg width="44" height="31" viewBox="0 0 44 31" fill="none" xmlns="http://www.w3.org/2000/svg">
				<path d="M6.17065 6.17037C6.17065 2.76257 8.93322 0 12.341 0H43.1929V6.17037H6.17065Z" fill="#101010"/>
				<rect x="5.75732" y="12.3398" width="37.4336" height="6.17037" fill="#101010"/>
				<rect y="6.17188" width="6.17037" height="18.5111" fill="#101010"/>
				<path d="M6.17065 24.6836H43.1929V30.854H12.341C8.93323 30.854 6.17065 28.0914 6.17065 24.6836Z" fill="#101010"/>
			</svg>
		</div>
	</div>
</section>

<style>
	#bowl {
		touch-action: pan-y;
	}

	#logo-letters {
		position: absolute;
		inset: 0;
		pointer-events: none;
	}

	#logo-letters svg {
		position: absolute;
		pointer-events: all;
		cursor: grab;
		top: 0;
		left: 0;
	}

	#logo-letters svg:active {
		cursor: grabbing;
	}

	@media (max-width: 768px) {
		#logo-letters svg {
			pointer-events: none;
			cursor: default;
		}
	}
</style>

<script>
	import Matter from 'matter-js';

	// Attendre que le DOM soit chargé
	if (typeof window !== 'undefined')
	{
		const initPhysics = () =>
		{
			// Détecter si on est sur mobile
			const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;
			// Modules Matter.js
			const { Engine, Render, Runner, Bodies, Composite, Mouse, MouseConstraint, Events } = Matter;

			// Récupérer les éléments DOM
			const bowlElement = document.getElementById('bowl');
			const logoContainer = document.getElementById('logo-letters');
			const letters = Array.from(logoContainer!.querySelectorAll('svg'));

			if (!bowlElement || letters.length === 0) return;

			// Calculer les dimensions du bol
			// Calculer les dimensions et POSITION réelles du bowl
			const bowlRect = bowlElement.getBoundingClientRect();
			
			const width = bowlRect.width;
			const height = bowlRect.height;
			const offsetX = bowlRect.left;
			const offsetY = bowlRect.top;

			// Créer le moteur
			const engine = Engine.create();
			const world = engine.world;

			// Configuration de la gravité
			world.gravity.y = 1; // Gravité normale

			// Créer le bol (rectangle arrondi composé de murs)
			const bowlWalls = [];

			// Calculer les dimensions réelles
			const wallThickness = 2000;

			// Récupérer l'épaisseur de la bordure CSS
			const borderWidth = parseFloat(getComputedStyle(bowlElement).borderWidth) || 1;

			// Le rayon des coins basé sur la taille totale
			const cornerRadius = Math.min(width, height) / 2;

			// Calculer les positions et dimensions des murs droits
			const straightWallHeight = height - cornerRadius * 2;
			const straightWallWidth = width - cornerRadius * 2;

			// Mur gauche (EXTÉRIEUR - décalé vers la gauche)
			bowlWalls.push(Bodies.rectangle(
				-wallThickness / 2,
				cornerRadius + straightWallHeight / 2,
				wallThickness,
				straightWallHeight,
				{ isStatic: true, friction: 0.3, restitution: 0.3 }
			));

			// Mur droit (EXTÉRIEUR - décalé vers la droite)
			bowlWalls.push(Bodies.rectangle(
				width + wallThickness / 2,
				cornerRadius + straightWallHeight / 2,
				wallThickness,
				straightWallHeight,
				{ isStatic: true, friction: 0.3, restitution: 0.3 }
			));

			// Mur haut (EXTÉRIEUR - décalé vers le haut)
			bowlWalls.push(Bodies.rectangle(
				cornerRadius + straightWallWidth / 2,
				-wallThickness / 2,
				straightWallWidth,
				wallThickness,
				{ isStatic: true, friction: 0.3, restitution: 0.3 }
			));

			// Mur bas (EXTÉRIEUR - décalé vers le bas)
			bowlWalls.push(Bodies.rectangle(
				cornerRadius + straightWallWidth / 2,
				height + wallThickness / 2,
				straightWallWidth,
				wallThickness,
				{ isStatic: true, friction: 0.3, restitution: 0.3 }
			));

			// Créer les 4 coins arrondis avec des segments (EXTÉRIEURS)
			const segments = 20;
			const corners = [
				{ cx: cornerRadius, cy: cornerRadius, startAngle: Math.PI, endAngle: Math.PI * 1.5 }, // Coin haut-gauche
				{ cx: width - cornerRadius, cy: cornerRadius, startAngle: Math.PI * 1.5, endAngle: Math.PI * 2 }, // Coin haut-droit
				{ cx: width - cornerRadius, cy: height - cornerRadius, startAngle: 0, endAngle: Math.PI * 0.5 }, // Coin bas-droit
				{ cx: cornerRadius, cy: height - cornerRadius, startAngle: Math.PI * 0.5, endAngle: Math.PI } // Coin bas-gauche
			];

			corners.forEach(corner =>
			{
				const angleStep = (corner.endAngle - corner.startAngle) / segments;
				
				for (let i = 0; i < segments; i++)
				{
					const angle1 = corner.startAngle + i * angleStep;
					const angle2 = corner.startAngle + (i + 1) * angleStep;
					
					// Rayon EXTÉRIEUR (plus grand que le rayon visuel)
					const effectiveRadius = cornerRadius + wallThickness / 2;
					
					const x1 = corner.cx + effectiveRadius * Math.cos(angle1);
					const y1 = corner.cy + effectiveRadius * Math.sin(angle1);
					const x2 = corner.cx + effectiveRadius * Math.cos(angle2);
					const y2 = corner.cy + effectiveRadius * Math.sin(angle2);
					
					const wallLength = Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
					const wallAngle = Math.atan2(y2 - y1, x2 - x1);
					
					bowlWalls.push(Bodies.rectangle(
						(x1 + x2) / 2,
						(y1 + y2) / 2,
						wallLength,
						wallThickness,
						{
							isStatic: true,
							angle: wallAngle,
							friction: 0.3,
							restitution: 0.3
						}
					));
				}
			});

			Composite.add(world, bowlWalls);


			// Créer les corps physiques pour chaque lettre
			const letterBodies = letters.map((svg, index) =>
			{
				const width = 44;
				const height = 31;
				
				// Position initiale RELATIVE au bowl (pas à la page)
				const padding = 50;
				const startX = padding + Math.random() * (bowlRect.width - padding * 2);
				const startY = padding + Math.random() * (bowlRect.height - padding * 2);

				const body = Bodies.rectangle(startX, startY, width, height, {
					friction: 0.5,
					restitution: 0.2,
					density: 0.001,
					angle: (Math.random() - 0.5) * 0.5
				});

				svg.setAttribute('data-body-index', index.toString());
				
				return body;
			});

			Composite.add(world, letterBodies);

			// Setup Mouse Constraint uniquement sur desktop
			if (!isMobile) {
				const mouse = Mouse.create(bowlElement);

				// CRUCIAL : Ajuster la position de la souris pour correspondre au bowl
				mouse.element.removeEventListener("mousewheel", mouse.mousewheel);
				mouse.element.removeEventListener("DOMMouseScroll", mouse.mousewheel);

				const mouseConstraint = MouseConstraint.create(engine, {
					mouse: mouse,
					constraint: {
						stiffness: 0.2,
						render: {
							visible: false
						}
					}
				});

				// Intercepter les événements pour ajuster les coordonnées
				Events.on(mouseConstraint, 'mousemove', (event) => {
					const rect = bowlElement.getBoundingClientRect();
					mouse.position.x = event.mouse.position.x;
					mouse.position.y = event.mouse.position.y;
				});

				Composite.add(world, mouseConstraint);
			}

			// Créer le runner
			const runner = Runner.create();
			Runner.run(runner, engine);

			// Boucle d'animation pour synchroniser les SVG
			const updateLetters = () =>
			{
				letterBodies.forEach((body, index) =>
				{
					const svg = letters[index];
					const { x, y } = body.position;
					const angle = body.angle;

					// Centrer le SVG sur le corps physique
					// Les SVG font 44x31, donc le centre est à 22x15.5
					svg.style.transform = `translate(${x - 22}px, ${y - 15.5}px) rotate(${angle}rad)`;
					svg.style.transformOrigin = '22px 15.5px'; // Centre du SVG
				});

				requestAnimationFrame(updateLetters);
			};


			updateLetters();

			// const render = Render.create({
			// 	element: bowlElement,
			// 	engine: engine,
			// 	options: {
			// 		width: bowlRect.width,
			// 		height: bowlRect.height,
			// 		wireframes: true,
			// 		background: 'transparent'
			// 	}
			// });

			// // Positionner le canvas exactement sur le bowl
			// render.canvas.style.position = 'absolute';
			// render.canvas.style.top = '0';
			// render.canvas.style.left = '0';
			// render.canvas.style.pointerEvents = 'none';

			// Render.run(render);


			// Cleanup au démontage (pour Astro)
			return () =>
			{
				Runner.stop(runner);
				Engine.clear(engine);
			};
		};

		// Initialiser après le chargement
		if (document.readyState === 'loading')
		{
			document.addEventListener('DOMContentLoaded', initPhysics);
		}
		else
		{
			initPhysics();
		}
	}
</script>
